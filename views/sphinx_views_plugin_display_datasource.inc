<?php

class sphinx_views_plugin_display_datasource extends views_plugin_display {
  /**
  * Given a Views handler, return an array representing a Sphinx attribute.
  */
  protected function sphinx_attribute($handler) {
    $attribute = array();
    $schema = drupal_get_schema($handler->table);
    if ($schema && isset($handler->real_field, $schema['fields'][$handler->real_field]) && $handler->real_field != $handler->view->base_field) {
      $class = get_class($handler);

      // Get the Sphinx attribute type.
      // We use the handler class for special cases like timestamp where DB
      // column type is not enough information to determine the usage of the
      // field.
      $map = array(
        'serial'  => 'sql_attr_uint',
        'int'     => 'sql_attr_uint',
        'varchar' => 'sql_attr_str2ordinal',
        'float'   => 'sql_attr_float',
      );
      if (strpos($class, 'date') !== FALSE) {
        $attribute['type'] = 'sql_attr_timestamp';
      }
      else if (isset($map[$schema['fields'][$handler->real_field]['type']])) {
        $attribute['type'] = $map[$schema['fields'][$handler->real_field]['type']];
      }

      // Get the Views alias generated by this handler. This will be the name
      // of the Sphinx attribute.
      if ($handler->field_alias != 'unknown') {
        $attribute['name'] = $handler->field_alias;
      }
      else if (isset($handler->aliases[$handler->real_field])) {
        $attribute['name'] = $handler->aliases[$handler->real_field];
      }

      // Store the table, field, view & display that this attribute belongs to.
      $attribute['table']   = $handler->table;
      $attribute['field']   = $handler->real_field;
      $attribute['view']    = $this->view->name;
      $attribute['display'] = $this->view->display_handler->display->id;
    }
    return $attribute;
  }

  /**
   * Static function with key value pairs for options that should have
   * their values forced. UI components for these options will be hidden.
   */
  protected function force_options() {
    return array(
      'style_plugin'   => 'default',
      'style_options'  => NULL,
      'row_plugin'     => 'fields',
      'row_options'    => NULL,
      'access'         => NULL,
      'cache'          => NULL,
      'title'          => NULL,
      'use_ajax'       => NULL,
      'items_per_page' => NULL,
      'user_pager'     => NULL,
      'distinct'       => NULL,
      'sorts'          => array(),
      'arguments'      => array(),
      'header'         => '',
      'footer'         => '',
      'empty'          => '',
      'exposed_block'  => FALSE,
      'analyze-theme'  => NULL,
    );
  }

  /**
   * Write a SQL query with fully prefixed tables and replaced arguments.
   */
  protected function db_query($query, $args) {
    _db_query_callback($args, TRUE);
    $query = db_prefix_tables($query);
    $query = preg_replace_callback(DB_QUERY_REGEXP, '_db_query_callback', $query);
    return $query;
  }

  /**
   * Just say no.
   */
  function uses_breadcrumb() {
    return FALSE;
  }

  /**
   * Show no output.
   */
  function render() {
    parent::render();
    return '';
  }

  /**
   * Do not fully execute the view -- we only need the build the query object.
   * Generate an array representing a full description of this datasource for
   * Sphinx.
   */
  function execute() {
    $options = $this->get_option('sphinx_datasource');
    $this->view->build();
    $datasource = array(
      'attributes' => array(),
      'conf' => array(),
      'base_table' => $this->view->base_table,
    );

    // Build attributes first.
    foreach ($this->view->field as $handler) {
      $name = "{$handler->table}.{$handler->real_field}";
      if (!empty($options['attributes'][$name]['usage']) && $options['attributes'][$name]['usage'] === 'attribute') {
        if ($attribute = $this->sphinx_attribute($handler)) {
          $datasource['attributes'][$name] = $attribute;
          if (!empty($options['attributes'][$name]['facet'])) {
            $datasource['facets'][$name] = $attribute['name'];
          }
        }
      }
    }
    // Build MVA attributes next.
    foreach ($options['attributes'] as $settings) {
      if ($settings['usage'] === 'attribute' && isset($settings['view']['view'], $settings['view']['display'])) {
        if ($view = views_get_view($settings['view']['view'])) {
          $view->set_display($settings['view']['display']);
          if ($attribute = $view->execute_display()) {
            $name = "{$attribute['table']}.{$attribute['field']}";
            $datasource['attributes'][$name] = $attribute;
            if (!empty($options['attributes'][$name]['facet'])) {
              $datasource['facets'][$name] = $attribute['name'];
            }
          }
        }
      }
    }

    // Build configuration queries next.

    // Build the query.
    $sql_query = drupal_clone($this->view->query);
    $sql_query->add_where(0, "{$this->view->base_table}.{$this->view->base_field}" .' BETWEEN $start AND $end');
    $datasource['conf']['sql_query'] = $this->db_query($sql_query->query(), $sql_query->get_where_args());

    // Build the info query.
    $sql_query_info = drupal_clone($this->view->query);
    $sql_query_info->add_where(0, "{$this->view->base_table}.{$this->view->base_field}" .' = $id');
    $datasource['conf']['sql_query_info'] = $this->db_query($sql_query_info->query(), $sql_query_info->get_where_args());

    // Assume serial ids on the base table and step by 1000.
    $datasource['conf']['sql_query_range'] = "SELECT MIN({$this->view->base_field}), MAX({$this->view->base_field}) FROM {$this->view->base_table}";
    $datasource['conf']['sql_range_step'] = 1000;
    $datasource['conf']['sql_ranged_throttle'] = 0;

    // @TODO: here would be a good place to set database information in
    // multiDB scenarios.
    return $datasource;
  }

  /**
   * Provide the default form for setting options.
   */
  function options_form(&$form, &$form_state) {
    parent::options_form($form, $form_state);
    switch ($form_state['section']) {
      case 'sphinx_datasource':
        $form_option = array('#tree' => TRUE);
        $options = $this->get_option('sphinx_datasource');

        $form_option['help'] = array(
          '#type' => 'item',
          '#value' => t('Choose a usage type for each field in the search datasource. <strong>Content</strong> fields will be used to perform text searches. <strong>Attributes</strong> can be used to filter, sort or group the search results.')
        );

        $handlers = $this->display->handler->get_handlers('field');
        $form_option['attributes'] = array('#tree' => TRUE, '#theme' => 'sphinx_views_plugin_display_datasource');

        // @TODO: Rewrite this to support $handler->additional_fields
        foreach ($handlers as $field => $handler) {
          if ($handler->real_field !== $this->view->base_field) {
            $name = "{$handler->table}.{$handler->real_field}";
            $attribute = $this->sphinx_attribute($handler);
            $form_option['attributes'][$name] = array(
              '#title' => $handler->ui_name(),
              '#tree' => TRUE,
            );
            if (!empty($attribute['type'])) {
              $elem = str_replace('.', '-', $name);
              $usage_id = form_clean_id("attributes-{$elem}-usage");
              $facet_id = form_clean_id("attributes-{$elem}-facet");

              // Usage
              $default_usage = $attribute['type'] === 'sql_attr_str2ordinal' ? 'content' : 'attribute';
              $default_usage = isset($options['attributes'][$name]['usage']) ? $options['attributes'][$name]['usage'] : $default_usage;
              $form_option['attributes'][$name]['usage'] = array(
                '#type' => 'select',
                '#options' => array('content' => t('Content'), 'attribute' => t('Attribute')),
                '#default_value' => $default_usage,
                '#id' => $usage_id,
              );

              // Facet
              $default_facet = ($default_usage === 'attribute');
              $default_facet = isset($options['attributes'][$name]['facet']) ? $options['attributes'][$name]['facet'] : $default_facet;
              $form_option['attributes'][$name]['facet'] = array(
                '#type' => 'checkbox',
                '#default_value' => $default_facet,
                '#process' => array('views_process_dependency'),
                '#dependency' => array($usage_id => array('attribute')),
                '#id' => $facet_id,
              );
            }
            else {
              $form_option['attributes'][$name]['usage'] = array(
                '#type' => 'select',
                '#options' => array('content' => t('Content')),
                '#default_value' => 'content',
                '#value' => 'content',
                '#disabled' => TRUE,
              );
              $form_option['attributes'][$name]['facet'] = array(
                '#type' => 'checkbox',
                '#default_value' => FALSE,
                '#value' => FALSE,
                '#disabled' => TRUE,
              );
            }
          }
        }

        // Multi-valued attributes.
        foreach (sphinx_views_get_usable_views($this->view->base_table, 'sphinx_mva') as $view) {
          foreach ($view->display as $display) {
            if ($display->display_plugin === 'sphinx_mva') {
              $view = views_get_view($view->name);

              $view->set_display($display->id);
              $attribute = $view->execute_display();
              $name = "{$attribute['table']}.{$attribute['field']}";

              $elem = str_replace('.', '-', $name);
              $usage_id = form_clean_id("attributes-{$elem}-usage");
              $facet_id = form_clean_id("attributes-{$elem}-facet");

              $form_option['attributes'][$name] = array(
                '#title' => t('@display (@view)', array('@display' => $display->display_title, '@view' => $view->name)),
                '#tree' => TRUE,
              );

              // Usage
              $default_usage = 'attribute';
              $default_usage = isset($options['attributes'][$name]['usage']) ? $options['attributes'][$name]['usage'] : $default_usage;
              $form_option['attributes'][$name]['usage'] = array(
                '#type' => 'select',
                '#options' => array(0 => t('<'. t('Disabled') .'>'), 'attribute' => t('Multi-valued attribute')),
                '#default_value' => $default_usage,
                '#id' => $usage_id,
              );

              // Facet
              $default_facet = ($default_usage === 'attribute');
              $default_facet = isset($options['attributes'][$name]['facet']) ? $options['attributes'][$name]['facet'] : $default_facet;
              $form_option['attributes'][$name]['facet'] = array(
                '#type' => 'checkbox',
                '#default_value' => $default_facet,
                '#dependency' => array($usage_id => array('attribute')),
                '#id' => $facet_id,
              );

              // Store view
              $form_option['attributes'][$name]['view'] = array(
                '#type' => 'value',
                '#value' => array('view' => $view->name, 'display' => $display->id),
              );

              $view->destroy();
            }
          }
        }
        $form['sphinx_datasource'] = $form_option;
        break;
    }
  }

  /**
   * Perform any necessary changes to the form values prior to storage.
   * There is no need for this function to actually store the data.
   */
  function options_submit($form, &$form_state) {
    parent::options_submit($form, $form_state);
    switch ($form_state['section']) {
      case 'sphinx_datasource':
        $this->set_option($form_state['section'], $form_state['values'][$form_state['section']]);
        sphinx_views_invalidate_cache();
        break;
    }
  }

  /**
   * Provide the summary for attachment options in the views UI.
   *
   * This output is returned as an array.
   */
  function options_summary(&$categories, &$options) {
    parent::options_summary($categories, $options);
    $categories['basic'] = array('title' => t('Sphinx settings'));
    $options['sphinx_datasource'] = array(
      'category' => 'basic',
      'title' => t('Datasource settings'),
      'value' => t('Settings'),
    );
    foreach (array_keys($this->force_options()) as $key) {
      if (isset($options[$key])) {
        unset($options[$key]);
      }
    }
  }

  /**
   * Enforce the options described in ->force_options().
   */
  function option_definition() {
    $options = parent::option_definition();
    $options['sphinx_datasource'] = array('default' => array());

    foreach ($this->force_options() as $key => $value) {
      if (isset($options[$key]['default'], $value)) {
        $options[$key]['default'] = $value;
      }
      if (isset($options['defaults']['default'][$key])) {
        $options['defaults']['default'][$key] = FALSE;
      }
    }
    return $options;
  }

  /**
   * Validate handler.
   */
  function validate() {
    $errors = parent::validate();
    if ($this->get_option('sorts') || $this->get_option('arguments')) {
      $errors[] = t('Sphinx datasource displays may not use arguments or sorts.');
    }
    return $errors;
  }
}
